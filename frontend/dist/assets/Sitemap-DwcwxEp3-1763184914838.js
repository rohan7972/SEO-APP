import{j as e}from"./app-bridge-Dll4AwN--1763184914838.js";import{r as i}from"./react-vendor-tAaa2TlE-1763184914838.js";import{m as H}from"./sessionFetch-CJepNHo3-1763184914838.js";import{C as Q,B as r,a as x,d as R,I as u,n as F,T as t,b as G,o as f,p as y,q as Y,M as z,k as X}from"./polaris-DkgsK6SL-1763184914838.js";const K=(w,a="")=>{try{return new URLSearchParams(window.location.search).get(w)||a}catch{return a}};function ee({shop:w}){var $;const a=w||K("shop",""),[l,U]=i.useState(null),[v,I]=i.useState(!1),[C,h]=i.useState(""),[o,O]=i.useState(null),[n,A]=i.useState(null),[j,P]=i.useState(!1),b=i.useMemo(()=>H(),[]),[E,M]=i.useState(!1),[T,S]=i.useState(null),[_,B]=i.useState(!1),k=i.useCallback(async()=>{if(a)try{const s=await b(`/api/sitemap/info?shop=${a}`);U(s)}catch(s){h(s.message||"Failed to load sitemap info")}},[a,b]),L=i.useCallback(async()=>{var s,g,m;if(a)try{const d=await b("/graphql",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({query:`
        query PlansMe($shop:String!) {
          plansMe(shop:$shop) {
            shop
            plan
            planKey
            priceUsd
            product_limit
            collection_limit
            language_limit
            providersAllowed
            modelsSuggested
            autosyncCron
            trial {
              active
              ends_at
              days_left
            }
          }
        }
      `,variables:{shop:a}})});if((s=d==null?void 0:d.errors)!=null&&s.length)throw new Error(((g=d.errors[0])==null?void 0:g.message)||"GraphQL error");const p=(m=d==null?void 0:d.data)==null?void 0:m.plansMe;O(p||null)}catch{}},[a,b]),q=i.useCallback(async()=>{var s,g,m,c;if(a){I(!0),A(null);try{const d=await fetch(`/api/sitemap/generate?shop=${encodeURIComponent(a)}`,{method:"POST",credentials:"include",headers:{Authorization:`Bearer ${((m=(g=(s=window.__SHOPIFY_APP_BRIDGE__)==null?void 0:s.getState())==null?void 0:g.session)==null?void 0:m.token)||""}`,"Content-Type":"application/json"}});if(d.ok){const p=await d.json();console.log("[SITEMAP] Generation response:",p),p.success?(h(p.message||"Sitemap generation started!"),A(p.job),(c=p.job)!=null&&c.queued&&P(!0)):h(p.message||"Sitemap generation failed")}else{const p=await d.text();h(`Sitemap generation failed: ${p}`)}}catch(d){console.error("[SITEMAP] Generation error:",d),h(d.message||"Sitemap generation failed")}finally{I(!1)}}},[a]),W=i.useCallback(async()=>{if(!(!a||!j))try{const s=await b(`/api/sitemap/status?shop=${a}`);console.log("[SITEMAP] Status:",s),A(s.queue),(s.queue.status==="completed"||s.queue.status==="failed"||s.queue.status==="idle")&&(P(!1),h(s.queue.message||"Sitemap generation completed!"),await k())}catch(s){console.error("[SITEMAP] Status check error:",s)}},[a,j,b,k]);i.useEffect(()=>{if(j){const s=setInterval(W,3e3);return()=>clearInterval(s)}},[j,W]);const D=i.useCallback(async()=>{var s,g,m;if(a){M(!0),B(!0),S(null);try{console.log("[SITEMAP] Loading existing sitemap from database...");const c=await fetch(`/api/sitemap/generate?shop=${encodeURIComponent(a)}&force=true&t=${Date.now()}`,{method:"GET",credentials:"include",headers:{Authorization:`Bearer ${((m=(g=(s=window.__SHOPIFY_APP_BRIDGE__)==null?void 0:s.getState())==null?void 0:g.session)==null?void 0:m.token)||""}`}});if(c.ok){console.log("[SITEMAP] Sitemap XML loaded successfully");const d=await c.text();S(d)}else throw new Error(`HTTP ${c.status}: ${c.statusText}`)}catch(c){console.error("[SITEMAP] Error loading sitemap:",c),S(`Error loading sitemap: ${c.message}`)}finally{B(!1)}}},[a]);return i.useEffect(()=>{k(),L()},[k,L]),e.jsxs(Q,{children:[e.jsx(r,{padding:"400",children:e.jsxs(x,{gap:"400",children:[e.jsx(R,{tone:"info",children:e.jsxs("p",{children:["Your ",(o==null?void 0:o.plan)||"Starter"," plan includes up to"," ",e.jsxs("strong",{children:[(($=o==null?void 0:o.product_limit)==null?void 0:$.toLocaleString())||"70"," products in up to ",(o==null?void 0:o.language_limit)||1," language",((o==null?void 0:o.language_limit)||1)>1?"s":""]}),".",(l==null?void 0:l.productCount)&&(o==null?void 0:o.product_limit)&&l.productCount>o.product_limit&&e.jsxs(e.Fragment,{children:[" You have ",l.productCount," products, so only the first"," ",o.product_limit.toLocaleString()," ","will be included in the sitemap."]})]})}),(j||n)&&e.jsx(R,{tone:(n==null?void 0:n.status)==="processing"?"info":(n==null?void 0:n.status)==="failed"?"critical":"success",children:e.jsxs(x,{gap:"200",children:[e.jsxs(u,{gap:"200",blockAlign:"center",children:[j&&e.jsx(F,{size:"small"}),e.jsx(t,{variant:"bodyMd",fontWeight:"medium",children:(n==null?void 0:n.message)||"Processing..."})]}),(n==null?void 0:n.position)>0&&e.jsxs(t,{variant:"bodySm",tone:"subdued",children:["Position in queue: ",n.position," | Estimated time: ~",n.estimatedTime,"s"]}),(n==null?void 0:n.queueLength)>0&&e.jsxs(t,{variant:"bodySm",tone:"subdued",children:["Queue length: ",n.queueLength," job(s)"]})]})}),e.jsxs(u,{align:"space-between",blockAlign:"center",children:[e.jsxs(r,{children:[e.jsx(t,{variant:"headingMd",as:"h3",children:"Sitemap Generator"}),e.jsx(t,{variant:"bodySm",tone:"subdued",children:"Generate structured sitemap for AI models to discover and index your products"})]}),e.jsx(G,{primary:!0,onClick:q,loading:v,disabled:v,children:v?"Generating...":"Generate Sitemap"})]}),l&&e.jsx(r,{background:"bg-surface-secondary",padding:"400",borderRadius:"200",children:e.jsxs(x,{gap:"300",children:[e.jsx(u,{gap:"200",blockAlign:"center",children:l.generated?e.jsxs(e.Fragment,{children:[e.jsx(f,{source:y,tone:"success"}),e.jsx(t,{variant:"bodyMd",fontWeight:"semibold",tone:"success",children:"Sitemap Active"})]}):e.jsxs(e.Fragment,{children:[e.jsx(f,{source:Y}),e.jsx(t,{variant:"bodyMd",fontWeight:"semibold",children:"No Sitemap Found"})]})}),l.generated&&e.jsxs(x,{gap:"400",children:[e.jsx(r,{children:e.jsxs(x,{gap:"200",children:[e.jsx(r,{paddingBlockEnd:"200",borderBlockEndWidth:"025",borderColor:"border-subdued",children:e.jsxs(u,{align:"space-between",children:[e.jsx(t,{variant:"bodyMd",color:"subdued",children:"Products included"}),e.jsxs(t,{variant:"bodyMd",fontWeight:"semibold",children:[l.lastProductCount||0," URLs"]})]})}),e.jsx(r,{paddingBlockEnd:"200",borderBlockEndWidth:"025",borderColor:"border-subdued",children:e.jsxs(u,{align:"space-between",children:[e.jsx(t,{variant:"bodyMd",color:"subdued",children:"File size"}),e.jsx(t,{variant:"bodyMd",fontWeight:"semibold",children:l.size?`${(l.size/1024).toFixed(2)} KB`:"Unknown"})]})}),e.jsx(r,{paddingBlockEnd:"200",borderBlockEndWidth:"025",borderColor:"border-subdued",children:e.jsxs(u,{align:"space-between",children:[e.jsx(t,{variant:"bodyMd",color:"subdued",children:"Last updated"}),e.jsx(t,{variant:"bodyMd",fontWeight:"semibold",children:l.generatedAt?new Date(l.generatedAt).toLocaleString():"Unknown"})]})})]})}),e.jsx(r,{children:e.jsx(G,{fullWidth:!0,onClick:D,children:"View Sitemap"})})]})]})}),e.jsxs(r,{paddingBlockStart:"400",children:[e.jsx(t,{variant:"headingMd",as:"h4",children:"What's included:"}),e.jsx(r,{paddingBlockStart:"200",children:e.jsxs(x,{gap:"200",children:[e.jsxs(u,{gap:"200",blockAlign:"start",children:[e.jsx(r,{minWidth:"24px",children:e.jsx(f,{source:y,tone:"positive"})}),e.jsx(t,{children:"All active products with structured URLs for AI parsing"})]}),e.jsxs(u,{gap:"200",blockAlign:"start",children:[e.jsx(r,{minWidth:"24px",children:e.jsx(f,{source:y,tone:"positive"})}),e.jsx(t,{children:"Priority rankings to help AI models understand product importance"})]}),e.jsxs(u,{gap:"200",blockAlign:"start",children:[e.jsx(r,{minWidth:"24px",children:e.jsx(f,{source:y,tone:"positive"})}),e.jsx(t,{children:"Multi-language URLs for international AI search coverage"})]}),e.jsxs(u,{gap:"200",blockAlign:"start",children:[e.jsx(r,{minWidth:"24px",children:e.jsx(f,{source:y,tone:"positive"})}),e.jsx(t,{children:"Standard XML format that AI crawlers understand"})]})]})})]}),e.jsxs(r,{paddingBlockStart:"200",children:[e.jsx(t,{variant:"headingMd",as:"h4",children:"How it helps AI models:"}),e.jsx(r,{paddingBlockStart:"200",children:e.jsxs(x,{gap:"200",children:[e.jsx(t,{children:'1. Click "Generate Sitemap" to create a structured map of your products'}),e.jsx(t,{children:"2. The sitemap is automatically saved and available to AI crawlers"}),e.jsx(t,{children:"3. AI models can discover and understand your product catalog structure"}),e.jsx(t,{children:"4. Regenerate when you add new products to keep AI models updated"})]})})]})]})}),E&&e.jsx(z,{open:E,onClose:()=>{M(!1),S(null)},title:"AI-Optimized Sitemap",primaryAction:{content:"Copy",onAction:()=>{navigator.clipboard.writeText(T),h("Copied to clipboard!")},disabled:_},secondaryActions:[{content:"Close",onAction:()=>{M(!1),S(null)}}],children:e.jsx(z.Section,{children:e.jsx(r,{padding:"200",background:"bg-surface-secondary",borderRadius:"100",children:_?e.jsxs(u,{align:"center",gap:"200",children:[e.jsx(F,{size:"small"}),e.jsx(t,{variant:"bodyMd",children:"Loading sitemap XML... This may take a moment for large stores."})]}):e.jsx("pre",{style:{whiteSpace:"pre-wrap",fontFamily:"monospace",fontSize:"12px",margin:0,overflow:"auto",maxHeight:"400px"},children:T})})})}),C&&e.jsx(X,{content:C,onDismiss:()=>h("")})]})}export{ee as default};
